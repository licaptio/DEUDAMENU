<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Subir XMLs m√∫ltiples a Supabase (solo egresos)</title>
 <style>
  @media (max-width: 600px) {
    #manualForm {
      grid-template-columns: 1fr !important;
    }
  }
</style>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(
      'https://cvpbtjlupswbyxenugpz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
    );

    const registrosTemporales = [];
    const ignorados = [];

    window.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('xmlInput');
      const procesarBtn = document.getElementById('procesarBtn');
      const log = document.getElementById('log');
      const manualForm = document.getElementById('manualForm');
function agregarLinea(texto, tipo = "log") {
  log.textContent += texto + "\n";
  log.scrollTop = log.scrollHeight;

  if (tipo === "cargado") {
    const li = document.createElement("li");
    li.textContent = texto;
    document.getElementById("listaCargados").appendChild(li);
  }

  if (tipo === "ignorado") {
    const li = document.createElement("li");
    li.textContent = texto;
    document.getElementById("listaIgnorados").appendChild(li);
  }
}

  input.addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    for (const file of files) {
      const reader = new FileReader();
      reader.onload = function (event) {
  const parser = new DOMParser();
  const xml = parser.parseFromString(event.target.result, "application/xml");

  const comprobante = xml.documentElement;
  const tipoDeComprobante = comprobante.getAttribute("TipoDeComprobante");
  const uuidNode = xml.getElementsByTagNameNS("http://www.sat.gob.mx/TimbreFiscalDigital", "TimbreFiscalDigital")[0];
  const uuid = uuidNode?.getAttribute("UUID");

  if (tipoDeComprobante !== "I") {
    ignorados.push(`${uuid || 'SIN UUID'} (${tipoDeComprobante})`);
agregarLinea(`‚è≠Ô∏è Saltado: ${uuid || 'SIN UUID'} no es un ingreso (es tipo ${tipoDeComprobante})`, "ignorado");

    return;
  }

  const fecha = uuidNode?.getAttribute("FechaTimbrado");
  const rfc_emisor = xml.getElementsByTagNameNS("http://www.sat.gob.mx/cfd/4", "Emisor")[0]?.getAttribute("Rfc");
  const razon_social_emisor = xml.getElementsByTagNameNS("http://www.sat.gob.mx/cfd/4", "Emisor")[0]?.getAttribute("Nombre");
  const serie = comprobante.getAttribute("Serie") || "";
  const folio = comprobante.getAttribute("Folio") || "";
  const factura = `${serie}${folio}`;
  const total = comprobante.getAttribute("Total");

  const conceptos = Array.from(xml.getElementsByTagNameNS("http://www.sat.gob.mx/cfd/4", "Concepto"));
  const listaConceptos = conceptos.map(el => {
    const cantidad = el.getAttribute("Cantidad");
    const claveProdServ = el.getAttribute("ClaveProdServ");
    const claveUnidad = el.getAttribute("ClaveUnidad");
    const descripcion = el.getAttribute("Descripcion");
    const importe = el.getAttribute("Importe");
    const unidad = el.getAttribute("Unidad");
    const valorUnitario = el.getAttribute("ValorUnitario");
    const objetoImp = el.getAttribute("ObjetoImp");

    const traslados = Array.from(el.getElementsByTagNameNS("http://www.sat.gob.mx/cfd/4", "Traslado"));
    const impuestos = traslados.map(t => {
      const impuesto = t.getAttribute("Impuesto");
      const tasa = t.getAttribute("TasaOCuota");
      const importeImp = t.getAttribute("Importe");
      return `Impuesto: ${impuesto} | Tasa: ${tasa} | Importe: ${importeImp}`;
    }).join(" / ");

    return `Cantidad: ${cantidad} | ClaveProdServ: ${claveProdServ} | ClaveUnidad: ${claveUnidad} | Descripci√≥n: ${descripcion} | Importe: ${importe} | Unidad: ${unidad} | ValorUnitario: ${valorUnitario} | ObjetoImp: ${objetoImp}` + (impuestos ? ` | ${impuestos}` : '');
  }).filter(Boolean);

  const concepto = listaConceptos.join("\\n");

  const data = {
    uuid,
    fecha,
    rfc_emisor,
    razon_social_emisor,
    factura,
    total: parseFloat(total),
    factura_fisicamente: '',
    comentario_factura_fisica: '',
    factura_pagada: 'NO',
    concepto
  };

  registrosTemporales.push(data);
agregarLinea(`üìù Ingreso cargado: UUID ${uuid}`, "cargado");

};

  </script>
</head>
<body style="font-family: sans-serif; background: #f4f4f4; padding: 20px;">
  <h2>Subir XMLs (solo ingresos tipo I) y procesar</h2>
  <input type="file" id="xmlInput" accept=".xml" multiple>
  <button id="procesarBtn" style="margin-top: 10px; padding: 10px 15px;">Procesar registros cargados</button>
  <pre id="log" style="background: #eef; padding: 15px; border-radius: 5px; height: 300px; overflow-y: auto;"></pre>
<div style="margin-top: 20px;">
  <h4>üìÇ Archivos cargados v√°lidos:</h4>
  <ul id="listaCargados" style="background: #e0ffe0; padding: 10px; border-radius: 5px;"></ul>

  <h4>üö´ Archivos ignorados:</h4>
  <ul id="listaIgnorados" style="background: #ffe0e0; padding: 10px; border-radius: 5px;"></ul>
</div>

  <h3>Agregar deuda manual (ej. impuestos, servicios)</h3>
<form id="manualForm" style="background: #fff; padding: 20px; border-radius: 10px; max-width: 800px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
  <div>
    <label for="fechaManual">Fecha:</label>
    <input type="date" id="fechaManual" required style="width: 100%;">
  </div>

  <div>
    <label for="proveedorManual">Proveedor:</label>
    <input type="text" id="proveedorManual" placeholder="SAT o nombre" required style="width: 100%;">
  </div>

  <div>
    <label for="rfcManual">RFC (opcional):</label>
    <input type="text" id="rfcManual" placeholder="Ej. SAT990101SAT" style="width: 100%;">
  </div>

  <div>
    <label for="facturaManual">Factura / Folio interno:</label>
    <input type="text" id="facturaManual" placeholder="Ej. IMP-306090" required style="width: 100%;">
  </div>

  <div>
    <label for="totalManual">Total:</label>
    <input type="number" id="totalManual" step="0.01" required style="width: 100%;">
  </div>

  <div>
    <label for="comentarioManual">Comentario:</label>
    <input type="text" id="comentarioManual" placeholder="Ej. Pago ISR mayo" required style="width: 100%;">
  </div>

  <div style="grid-column: span 2;">
    <label for="conceptoManual">Concepto general:</label>
    <textarea id="conceptoManual" rows="2" placeholder="Ej. Pago de impuestos federales" style="width: 100%;"></textarea>
  </div>

  <div style="grid-column: span 2; text-align: center;">
    <button type="submit" style="padding: 10px 20px; font-weight: bold;">Registrar deuda manual</button>
  </div>
</form>

</body>
</html>

