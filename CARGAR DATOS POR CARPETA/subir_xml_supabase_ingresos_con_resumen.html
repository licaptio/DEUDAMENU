<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Subir XMLs m√∫ltiples a Supabase (solo egresos)</title>
 <style>
  @media (max-width: 600px) {
    #manualForm {
      grid-template-columns: 1fr !important;
    }
  }
</style>
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(
      'https://cvpbtjlupswbyxenugpz.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY'
    );

    const registrosTemporales = [];
    const ignorados = [];

    window.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('xmlInput');
      const procesarBtn = document.getElementById('procesarBtn');
      const log = document.getElementById('log');
      const manualForm = document.getElementById('manualForm');

      // Asignar fecha actual al formulario manual
      document.getElementById('fechaManual').valueAsDate = new Date();

      function generarUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      function agregarLinea(texto) {
        log.textContent += texto + "\n";
        log.scrollTop = log.scrollHeight;
      }

      manualForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const uuid = generarUUID();
        const fecha = document.getElementById('fechaManual').value;
        const razon_social_emisor = document.getElementById('proveedorManual').value.trim();
        const rfc_emisor = document.getElementById('rfcManual').value.trim() || "XAXX010101000";
        const factura = document.getElementById('facturaManual').value.trim();
        const total = parseFloat(document.getElementById('totalManual').value);
        const comentario_factura_fisica = document.getElementById('comentarioManual').value.trim();
        const concepto = document.getElementById('conceptoManual').value.trim() || "Deuda capturada manualmente";

        const data = {
          uuid,
          fecha,
          razon_social_emisor,
          rfc_emisor,
          factura,
          total,
          factura_pagada: "NO",
          factura_fisicamente: "SI",
          comentario_factura_fisica,
          concepto
        };

        const { error } = await supabase
          .from('deuda_pddprotec25')
          .insert([data]);

        if (error) {
          agregarLinea(`‚ùå Error al insertar deuda manual: ${error.message}`);
          alert("Error: " + error.message);
        } else {
          agregarLinea(`‚úÖ Deuda manual registrada: ${uuid}`);
          alert("‚úÖ Deuda manual guardada correctamente");
          manualForm.reset();
          document.getElementById('fechaManual').valueAsDate = new Date();
        }
      });

      procesarBtn.addEventListener('click', async () => {
        let totalInsertados = 0;
        let totalActualizados = 0;
        let totalSinCambios = 0;
        let totalErrores = 0;

        if (registrosTemporales.length === 0 && ignorados.length === 0) {
          agregarLinea("‚ö†Ô∏è No hay archivos cargados para procesar.");
          return;
        }

        for (let i = 0; i < registrosTemporales.length; i++) {
          const data = registrosTemporales[i];
          agregarLinea(`üîç Procesando UUID: ${data.uuid}`);

          const { data: existente, error } = await supabase
            .from('deuda_pddprotec25')
            .select('*')
            .eq('uuid', data.uuid)
            .single();

          if (error || !existente) {
            const { error: insertError } = await supabase
              .from('deuda_pddprotec25')
              .insert([data]);

            if (insertError) {
              totalErrores++;
              agregarLinea(`‚ùå Error al insertar ${data.uuid}: ${insertError.message}`);
            } else {
              totalInsertados++;
              agregarLinea(`‚úÖ Insertado: ${data.uuid}`);
            }
          } else {
            const cambios = {};
            const camposProtegidos = ["factura_pagada", "factura_fisicamente", "comentario_factura_fisica"];

            for (const key in data) {
              if (
                key !== "uuid" &&
                !camposProtegidos.includes(key) &&
                data[key] !== existente[key]
              ) {
                cambios[key] = data[key];
              }
            }

            if (Object.keys(cambios).length > 0) {
              const { error: updateError } = await supabase
                .from('deuda_pddprotec25')
                .update(cambios)
                .eq('uuid', data.uuid);

              if (updateError) {
                agregarLinea(`‚ùå Error al actualizar ${data.uuid}: ${updateError.message}`);
              } else {
                totalActualizados++;
                agregarLinea(`üîÅ Actualizado: ${data.uuid}`);
              }
            } else {
              totalSinCambios++;
              agregarLinea(`‚ûñ Sin cambios en ${data.uuid}, no se modific√≥.`);
            }
          }
        }

        if (ignorados.length > 0) {
          agregarLinea("üìå UUIDs ignorados por no ser tipo E:");
          ignorados.forEach(u => agregarLinea(`- ${u}`));
        }

        agregarLinea("üéâ Procesamiento finalizado.");
        agregarLinea("üìä Resumen:");
        agregarLinea(`‚úÖ Insertados: ${totalInsertados}`);
        agregarLinea(`üîÅ Actualizados: ${totalActualizados}`);
        agregarLinea(`‚ûñ Sin cambios: ${totalSinCambios}`);
        agregarLinea(`‚è≠Ô∏è Ignorados (otros tipos): ${ignorados.length}`);
        agregarLinea(`‚ùå Errores: ${totalErrores}`);

        registrosTemporales.length = 0;
      });
    });
  </script>
</head>
<body style="font-family: sans-serif; background: #f4f4f4; padding: 20px;">
  <h2>Subir XMLs (solo ingresos tipo I) y procesar</h2>
  <input type="file" id="xmlInput" accept=".xml" multiple>
  <button id="procesarBtn" style="margin-top: 10px; padding: 10px 15px;">Procesar registros cargados</button>
  <pre id="log" style="background: #eef; padding: 15px; border-radius: 5px; height: 300px; overflow-y: auto;"></pre>

  <h3>Agregar deuda manual (ej. impuestos, servicios)</h3>
<form id="manualForm" style="background: #fff; padding: 20px; border-radius: 10px; max-width: 800px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
  <div>
    <label for="fechaManual">Fecha:</label>
    <input type="date" id="fechaManual" required style="width: 100%;">
  </div>

  <div>
    <label for="proveedorManual">Proveedor:</label>
    <input type="text" id="proveedorManual" placeholder="SAT o nombre" required style="width: 100%;">
  </div>

  <div>
    <label for="rfcManual">RFC (opcional):</label>
    <input type="text" id="rfcManual" placeholder="Ej. SAT990101SAT" style="width: 100%;">
  </div>

  <div>
    <label for="facturaManual">Factura / Folio interno:</label>
    <input type="text" id="facturaManual" placeholder="Ej. IMP-306090" required style="width: 100%;">
  </div>

  <div>
    <label for="totalManual">Total:</label>
    <input type="number" id="totalManual" step="0.01" required style="width: 100%;">
  </div>

  <div>
    <label for="comentarioManual">Comentario:</label>
    <input type="text" id="comentarioManual" placeholder="Ej. Pago ISR mayo" required style="width: 100%;">
  </div>

  <div style="grid-column: span 2;">
    <label for="conceptoManual">Concepto general:</label>
    <textarea id="conceptoManual" rows="2" placeholder="Ej. Pago de impuestos federales" style="width: 100%;"></textarea>
  </div>

  <div style="grid-column: span 2; text-align: center;">
    <button type="submit" style="padding: 10px 20px; font-weight: bold;">Registrar deuda manual</button>
  </div>
</form>

</body>
</html>

